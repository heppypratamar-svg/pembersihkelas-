<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checklist Kebersihan Kelas - SMA Negeri Mojoagung</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        .task-item {
            transition: all 0.3s ease;
        }
        
        .task-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
        }
        
        .photo-preview {
            transition: all 0.3s ease;
        }
        
        .photo-preview:hover {
            transform: scale(1.05);
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gradient-to-br from-green-50 via-emerald-50 to-teal-100">
  <div class="min-h-full p-4 md:p-6">
   <div class="max-w-5xl mx-auto"><!-- Header -->
    <header class="glass-effect rounded-2xl shadow-xl p-6 mb-6 fade-in border-2 border-green-200">
     <div class="flex items-center gap-4 mb-4">
      <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl flex items-center justify-center shadow-lg">
       <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
       </svg>
      </div>
      <div class="flex-1">
       <h1 id="app-title" class="text-3xl font-bold text-gray-800 mb-1">Checklist Kebersihan Kelas</h1>
       <p id="school-name" class="text-gray-600 font-medium">SMA Negeri Mojoagung</p>
      </div>
     </div>
     <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl p-4">
      <p class="text-sm text-gray-700"><span class="font-bold text-green-700">üìã Petunjuk:</span> Pilih kelas dan hari piket, isi tugas yang dikerjakan dengan foto bukti, lalu kirim laporan.</p>
     </div>
    </header><!-- Form Section -->
    <main class="glass-effect rounded-2xl shadow-xl p-6 mb-6 slide-in border-2 border-green-200">
     <h2 class="text-xl font-bold text-gray-800 mb-5 flex items-center gap-2"><span class="w-10 h-10 bg-gradient-to-br from-green-100 to-emerald-100 rounded-xl flex items-center justify-center text-green-600 text-xl">üìù</span> Informasi Piket</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div><label for="kelas-select" class="block text-sm font-bold text-gray-700 mb-2">Tingkat &amp; Kelas <span class="text-red-500">*</span></label> <select id="kelas-select" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-200 focus:outline-none transition-all bg-white"> <option value="">Pilih Kelas</option> <optgroup label="Kelas X"> <option value="X-1">X-1</option> <option value="X-2">X-2</option> <option value="X-3">X-3</option> <option value="X-4">X-4</option> <option value="X-5">X-5</option> <option value="X-6">X-6</option> <option value="X-7">X-7</option> <option value="X-8">X-8</option> <option value="X-9">X-9</option> </optgroup> <optgroup label="Kelas XI"> <option value="XI-1">XI-1</option> <option value="XI-2">XI-2</option> <option value="XI-3">XI-3</option> <option value="XI-4">XI-4</option> <option value="XI-5">XI-5</option> <option value="XI-6">XI-6</option> <option value="XI-7">XI-7</option> <option value="XI-8">XI-8</option> <option value="XI-9">XI-9</option> </optgroup> <optgroup label="Kelas XII"> <option value="XII-1">XII-1</option> <option value="XII-2">XII-2</option> <option value="XII-3">XII-3</option> <option value="XII-4">XII-4</option> <option value="XII-5">XII-5</option> <option value="XII-6">XII-6</option> <option value="XII-7">XII-7</option> <option value="XII-8">XII-8</option> <option value="XII-9">XII-9</option> </optgroup> </select>
      </div>
      <div><label for="hari-select" class="block text-sm font-bold text-gray-700 mb-2">Hari Piket <span class="text-red-500">*</span></label> <select id="hari-select" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-200 focus:outline-none transition-all bg-white"> <option value="">Pilih Hari</option> <option value="Senin">Senin</option> <option value="Selasa">Selasa</option> <option value="Rabu">Rabu</option> <option value="Kamis">Kamis</option> <option value="Jumat">Jumat</option> </select>
      </div>
     </div><!-- Jadwal Piket Display -->
     <div id="jadwal-info" class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl p-5 mb-4 border-2 border-green-300 hidden">
      <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2 text-base"><span class="text-2xl">üë•</span> Petugas Piket Hari Ini</h3>
      <p id="jadwal-text" class="text-gray-700 font-medium"></p>
     </div>
    </main><!-- Checklist Tasks -->
    <section class="glass-effect rounded-2xl shadow-xl p-6 mb-6 slide-in border-2 border-green-200">
     <h2 class="text-xl font-bold text-gray-800 mb-5 flex items-center gap-2"><span class="w-10 h-10 bg-gradient-to-br from-green-100 to-emerald-100 rounded-xl flex items-center justify-center text-green-600 text-xl">‚ú®</span> Daftar Tugas Kebersihan</h2>
     <div class="space-y-4" id="task-list"><!-- Task items will be generated by JavaScript -->
     </div>
    </section><!-- Submit Button -->
    <div class="glass-effect rounded-2xl shadow-xl p-6 fade-in border-2 border-green-200"><button id="submit-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 px-6 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none shadow-lg mb-3"> <span id="submit-btn-text" class="text-lg">Kirim Laporan Kebersihan</span> </button> <button id="history-btn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 px-6 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105 shadow-lg"> <span class="text-lg">üìã Lihat Riwayat Laporan</span> </button>
     <p class="text-sm text-gray-600 text-center mt-4 font-medium">‚ö†Ô∏è Minimal satu tugas harus diselesaikan dengan foto bukti</p>
    </div><!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
     <div class="glass-effect rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90%] overflow-hidden border-2 border-green-200">
      <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 flex items-center justify-between">
       <h2 class="text-2xl font-bold text-white flex items-center gap-3">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg> Riwayat Laporan Kebersihan</h2><button id="close-modal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg></button>
      </div><!-- Filter Section -->
      <div class="p-6 bg-gradient-to-r from-green-50 to-emerald-50 border-b-2 border-green-200">
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label for="filter-kelas" class="block text-sm font-bold text-gray-700 mb-2">Filter Kelas</label> <select id="filter-kelas" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 focus:outline-none bg-white"> <option value="">Semua Kelas</option> <optgroup label="Kelas X"> <option value="X-1">X-1</option> <option value="X-2">X-2</option> <option value="X-3">X-3</option> <option value="X-4">X-4</option> <option value="X-5">X-5</option> <option value="X-6">X-6</option> <option value="X-7">X-7</option> <option value="X-8">X-8</option> <option value="X-9">X-9</option> </optgroup> <optgroup label="Kelas XI"> <option value="XI-1">XI-1</option> <option value="XI-2">XI-2</option> <option value="XI-3">XI-3</option> <option value="XI-4">XI-4</option> <option value="XI-5">XI-5</option> <option value="XI-6">XI-6</option> <option value="XI-7">XI-7</option> <option value="XI-8">XI-8</option> <option value="XI-9">XI-9</option> </optgroup> <optgroup label="Kelas XII"> <option value="XII-1">XII-1</option> <option value="XII-2">XII-2</option> <option value="XII-3">XII-3</option> <option value="XII-4">XII-4</option> <option value="XII-5">XII-5</option> <option value="XII-6">XII-6</option> <option value="XII-7">XII-7</option> <option value="XII-8">XII-8</option> <option value="XII-9">XII-9</option> </optgroup> </select>
        </div>
        <div><label for="filter-hari" class="block text-sm font-bold text-gray-700 mb-2">Filter Hari</label> <select id="filter-hari" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 focus:outline-none bg-white"> <option value="">Semua Hari</option> <option value="Senin">Senin</option> <option value="Selasa">Selasa</option> <option value="Rabu">Rabu</option> <option value="Kamis">Kamis</option> <option value="Jumat">Jumat</option> </select>
        </div>
        <div class="flex items-end"><button id="reset-filter" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-all"> üîÑ Reset Filter </button>
        </div>
       </div>
      </div>
      <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 280px);">
       <div id="history-content" class="space-y-4"><!-- History items will be inserted here -->
       </div>
       <div id="no-history" class="text-center py-12 hidden">
        <div class="text-6xl mb-4">
         üì≠
        </div>
        <p class="text-gray-600 font-bold text-lg">Belum ada riwayat laporan</p>
        <p class="text-gray-500 text-sm mt-2">Laporan yang sudah dikirim akan muncul di sini</p>
       </div>
      </div>
     </div>
    </div><!-- Success Toast -->
    <div id="success-toast" class="fixed top-6 right-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-xl shadow-2xl hidden fade-in z-50">
     <div class="flex items-center gap-3">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg><span class="font-bold">Laporan berhasil dikirim! ‚úì</span>
     </div>
    </div><!-- Error Toast -->
    <div id="error-toast" class="fixed top-6 right-6 bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-4 rounded-xl shadow-2xl hidden fade-in z-50">
     <div class="flex items-center gap-3">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg><span class="font-bold" id="error-text">Terjadi kesalahan!</span>
     </div>
    </div>
   </div>
  </div>
  <script>
        const defaultConfig = {
            school_name: 'SMA Negeri Mojoagung',
            app_title: 'Checklist Kebersihan Kelas',
            submit_button_text: 'Kirim Laporan Kebersihan',
            background_color: '#f0fdf4',
            surface_color: '#ffffff',
            text_color: '#1f2937',
            primary_action_color: '#10b981',
            secondary_action_color: '#059669'
        };

        const tasks = [
            { id: 1, name: 'Menyapu Lantai', icon: 'üßπ', color: 'from-green-100 to-emerald-100' },
            { id: 2, name: 'Menghapus Papan Tulis', icon: 'üìù', color: 'from-teal-100 to-cyan-100' },
            { id: 3, name: 'Menaikkan Kursi ke Atas Meja', icon: 'ü™ë', color: 'from-emerald-100 to-green-100' },
            { id: 4, name: 'Merapikan Meja Guru', icon: 'üìö', color: 'from-lime-100 to-green-100' },
            { id: 5, name: 'Mematikan Lampu dan Kipas', icon: 'üí°', color: 'from-green-100 to-teal-100' },
            { id: 6, name: 'Mengepel Lantai', icon: 'üßΩ', color: 'from-cyan-100 to-emerald-100' }
        ];

        const jadwalPiket = {
            'Senin': 'Absen 1-7',
            'Selasa': 'Absen 8-14',
            'Rabu': 'Absen 15-21',
            'Kamis': 'Absen 22-28',
            'Jumat': 'Absen 29-36'
        };

        let photoData = {};

        // Initialize task list
        function initTaskList() {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = tasks.map(task => `
                <div class="task-item border-3 border-gray-200 rounded-xl p-5 hover:border-green-400 transition-all bg-white shadow-md">
                    <div class="flex items-start gap-4">
                        <div class="w-14 h-14 bg-gradient-to-br ${task.color} rounded-2xl flex items-center justify-center text-3xl flex-shrink-0 shadow-md">
                            ${task.icon}
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800 mb-3 text-lg">${task.id}. ${task.name}</h3>
                            
                            <!-- Name Input -->
                            <div class="mb-3">
                                <label for="petugas-${task.id}" class="block text-sm font-bold text-gray-700 mb-1">Nama Petugas</label>
                                <input 
                                    type="text" 
                                    id="petugas-${task.id}" 
                                    placeholder="Contoh: Ahmad Rizki"
                                    class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 focus:outline-none text-sm transition-all"
                                >
                            </div>
                            
                            <!-- Photo Upload -->
                            <div class="mb-3">
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    üì∏ Foto Bukti <span class="text-gray-500">(wajib jika tugas diselesaikan)</span>
                                </label>
                                <input 
                                    type="file" 
                                    id="photo-${task.id}" 
                                    accept="image/*"
                                    class="hidden"
                                >
                                <button 
                                    type="button"
                                    onclick="document.getElementById('photo-${task.id}').click()"
                                    class="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all text-sm font-bold shadow-md hover:shadow-lg transform hover:scale-105"
                                >
                                    üì∑ Unggah Foto Bukti
                                </button>
                                <div id="preview-${task.id}" class="mt-3 hidden">
                                    <img id="preview-img-${task.id}" class="w-40 h-40 object-cover rounded-xl photo-preview border-3 border-green-400 shadow-lg" alt="Preview foto tugas ${task.id}">
                                    <p class="text-xs text-green-600 font-bold mt-2 flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        Foto berhasil diunggah
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Checkbox -->
                            <label for="task-${task.id}" class="flex items-center gap-2 cursor-pointer group">
                                <input 
                                    type="checkbox" 
                                    id="task-${task.id}"
                                    class="w-5 h-5 rounded border-2 border-gray-400 text-green-600 focus:ring-green-500 focus:ring-2 cursor-pointer"
                                >
                                <span class="text-sm font-bold text-gray-700 group-hover:text-green-600 transition-colors">Tugas selesai dikerjakan</span>
                            </label>
                            
                            <div id="time-${task.id}" class="mt-3 text-xs text-gray-600 font-semibold bg-green-50 px-3 py-2 rounded-lg hidden border border-green-200">
                                <span class="text-green-700">‚è∞ Selesai pada:</span> <span id="time-text-${task.id}"></span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Add event listeners
            tasks.forEach(task => {
                const photoInput = document.getElementById(`photo-${task.id}`);
                photoInput.addEventListener('change', (e) => handlePhotoUpload(task.id, e));
                
                const checkbox = document.getElementById(`task-${task.id}`);
                checkbox.addEventListener('change', (e) => handleCheckboxChange(task.id, e));
            });
        }

        // Handle photo upload
        function handlePhotoUpload(taskId, event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5000000) {
                    showToast('error', 'Ukuran foto terlalu besar! Maksimal 5MB');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById(`preview-${taskId}`);
                    const previewImg = document.getElementById(`preview-img-${taskId}`);
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                    
                    photoData[`photo-${taskId}`] = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Handle checkbox change
        function handleCheckboxChange(taskId, event) {
            if (event.target.checked) {
                const now = new Date();
                const timeStr = now.toLocaleString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });
                
                const timeDiv = document.getElementById(`time-${taskId}`);
                const timeText = document.getElementById(`time-text-${taskId}`);
                timeText.textContent = timeStr;
                timeDiv.classList.remove('hidden');
                
                photoData[`time-${taskId}`] = now.toISOString();
            } else {
                const timeDiv = document.getElementById(`time-${taskId}`);
                timeDiv.classList.add('hidden');
                delete photoData[`time-${taskId}`];
            }
        }

        // Update jadwal info
        document.getElementById('hari-select').addEventListener('change', (e) => {
            const hari = e.target.value;
            const jadwalInfo = document.getElementById('jadwal-info');
            const jadwalText = document.getElementById('jadwal-text');
            
            if (hari && jadwalPiket[hari]) {
                jadwalText.textContent = `${jadwalPiket[hari]} bertugas piket pada hari ${hari}`;
                jadwalInfo.classList.remove('hidden');
            } else {
                jadwalInfo.classList.add('hidden');
            }
        });

        // Show toast message
        function showToast(type, text = '') {
            const successToast = document.getElementById('success-toast');
            const errorToast = document.getElementById('error-toast');
            
            if (type === 'success') {
                successToast.classList.remove('hidden');
                setTimeout(() => successToast.classList.add('hidden'), 4000);
            } else {
                if (text) {
                    document.getElementById('error-text').textContent = text;
                }
                errorToast.classList.remove('hidden');
                setTimeout(() => errorToast.classList.add('hidden'), 5000);
            }
        }

        // Submit handler
        document.getElementById('submit-btn').addEventListener('click', async () => {
            const kelas = document.getElementById('kelas-select').value;
            const hari = document.getElementById('hari-select').value;
            
            if (!kelas || !hari) {
                showToast('error', 'Pilih kelas dan hari terlebih dahulu!');
                return;
            }

            // Validate - at least one task must be completed with photo
            let hasCompletedTask = false;
            let hasPhotoUploaded = false;
            let allValid = true;
            
            const recordData = {
                id: `${kelas}-${hari}-${Date.now()}`,
                tanggal: new Date().toISOString(),
                kelas: kelas,
                hari: hari,
                status: 'Selesai'
            };

            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`task-${i}`);
                const photo = photoData[`photo-${i}`];
                const petugas = document.getElementById(`petugas-${i}`).value.trim();
                
                // If task is checked, validate it has photo
                if (checkbox.checked) {
                    hasCompletedTask = true;
                    
                    if (!photo) {
                        showToast('error', `Tugas ${i} (${tasks[i-1].name}) dicentang tapi belum ada foto bukti!`);
                        allValid = false;
                        break;
                    }
                    
                    recordData[`tugas_${i}_selesai`] = true;
                    recordData[`tugas_${i}_foto`] = `foto_tugas_${i}_uploaded`;
                    recordData[`tugas_${i}_waktu`] = photoData[`time-${i}`] || new Date().toISOString();
                    recordData[`tugas_${i}_petugas`] = petugas || 'Tidak disebutkan';
                    
                    hasPhotoUploaded = true;
                } else {
                    // Task not completed
                    recordData[`tugas_${i}_selesai`] = false;
                    recordData[`tugas_${i}_foto`] = 'Tidak ada foto';
                    recordData[`tugas_${i}_waktu`] = '';
                    recordData[`tugas_${i}_petugas`] = 'Tidak dikerjakan';
                }
            }

            if (!allValid) return;
            
            if (!hasCompletedTask) {
                showToast('error', 'Minimal satu tugas harus diselesaikan!');
                return;
            }
            
            if (!hasPhotoUploaded) {
                showToast('error', 'Minimal satu foto bukti harus diunggah!');
                return;
            }

            recordData.submitted_at = new Date().toISOString();

            // Disable button and show loading
            const submitBtn = document.getElementById('submit-btn');
            const submitBtnText = document.getElementById('submit-btn-text');
            submitBtn.disabled = true;
            submitBtnText.textContent = '‚è≥ Mengirim laporan...';

            try {
                const result = await window.dataSdk.create(recordData);

                submitBtn.disabled = false;
                submitBtnText.textContent = window.elementSdk?.config?.submit_button_text || defaultConfig.submit_button_text;

                if (result.isOk) {
                    showToast('success');
                    
                    // Reset form
                    document.getElementById('kelas-select').value = '';
                    document.getElementById('hari-select').value = '';
                    document.getElementById('jadwal-info').classList.add('hidden');
                    
                    tasks.forEach(task => {
                        document.getElementById(`task-${task.id}`).checked = false;
                        document.getElementById(`petugas-${task.id}`).value = '';
                        document.getElementById(`photo-${task.id}`).value = '';
                        document.getElementById(`preview-${task.id}`).classList.add('hidden');
                        document.getElementById(`time-${task.id}`).classList.add('hidden');
                    });
                    
                    photoData = {};
                } else {
                    showToast('error', 'Gagal mengirim laporan. Silakan coba lagi.');
                }
            } catch (err) {
                submitBtn.disabled = false;
                submitBtnText.textContent = window.elementSdk?.config?.submit_button_text || defaultConfig.submit_button_text;
                showToast('error', 'Terjadi kesalahan saat mengirim. Coba lagi.');
            }
        });

        // Data SDK Handler
        let allReports = [];
        
        const dataHandler = {
            onDataChanged(data) {
                allReports = data;
                if (document.getElementById('history-modal').classList.contains('hidden') === false) {
                    renderHistory();
                }
            }
        };
        
        // Render history
        function renderHistory() {
            const filterKelas = document.getElementById('filter-kelas').value;
            const filterHari = document.getElementById('filter-hari').value;
            
            let filteredReports = allReports.filter(report => {
                let match = true;
                if (filterKelas && report.kelas !== filterKelas) match = false;
                if (filterHari && report.hari !== filterHari) match = false;
                return match;
            });
            
            // Sort by date descending (newest first)
            filteredReports.sort((a, b) => {
                const dateA = new Date(a.tanggal);
                const dateB = new Date(b.tanggal);
                return dateB - dateA;
            });
            
            const historyContent = document.getElementById('history-content');
            const noHistory = document.getElementById('no-history');
            
            if (filteredReports.length === 0) {
                historyContent.innerHTML = '';
                noHistory.classList.remove('hidden');
                return;
            }
            
            noHistory.classList.add('hidden');
            
            historyContent.innerHTML = filteredReports.map(report => {
                const date = new Date(report.tanggal);
                const dateStr = date.toLocaleDateString('id-ID', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let completedTasks = [];
                for (let i = 1; i <= 6; i++) {
                    if (report[`tugas_${i}_selesai`]) {
                        const taskName = tasks[i-1].name;
                        const petugas = report[`tugas_${i}_petugas`] || 'Tidak disebutkan';
                        const waktu = report[`tugas_${i}_waktu`] ? new Date(report[`tugas_${i}_waktu`]).toLocaleString('id-ID', {
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : '-';
                        completedTasks.push({ id: i, name: taskName, petugas, waktu, icon: tasks[i-1].icon });
                    }
                }
                
                return `
                    <div class="bg-white rounded-xl shadow-lg border-2 border-green-200 overflow-hidden hover:shadow-xl transition-all">
                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 p-4 border-b-2 border-green-200">
                            <div class="flex flex-wrap items-center justify-between gap-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl font-bold text-green-700">${report.kelas}</span>
                                    <span class="text-gray-400">|</span>
                                    <span class="font-bold text-gray-700">${report.hari}</span>
                                </div>
                                <div class="flex items-center gap-2 text-sm">
                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="text-gray-600 font-medium">${dateStr}</span>
                                </div>
                            </div>
                        </div>
                        <div class="p-5">
                            <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <span class="text-green-600">‚úÖ</span>
                                Tugas yang Diselesaikan (${completedTasks.length}/6)
                            </h4>
                            <div class="space-y-2">
                                ${completedTasks.map(task => `
                                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-3 border border-green-200">
                                        <div class="flex items-start gap-3">
                                            <span class="text-2xl">${task.icon}</span>
                                            <div class="flex-1">
                                                <p class="font-bold text-gray-800">${task.name}</p>
                                                <div class="text-xs text-gray-600 mt-1 space-y-1">
                                                    <p><span class="font-semibold text-green-700">üë§ Petugas:</span> ${task.petugas}</p>
                                                    <p><span class="font-semibold text-green-700">‚è∞ Waktu:</span> ${task.waktu}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // History modal handlers
        document.getElementById('history-btn').addEventListener('click', () => {
            document.getElementById('history-modal').classList.remove('hidden');
            renderHistory();
        });
        
        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('history-modal').classList.add('hidden');
        });
        
        document.getElementById('history-modal').addEventListener('click', (e) => {
            if (e.target.id === 'history-modal') {
                document.getElementById('history-modal').classList.add('hidden');
            }
        });
        
        document.getElementById('filter-kelas').addEventListener('change', renderHistory);
        document.getElementById('filter-hari').addEventListener('change', renderHistory);
        
        document.getElementById('reset-filter').addEventListener('click', () => {
            document.getElementById('filter-kelas').value = '';
            document.getElementById('filter-hari').value = '';
            renderHistory();
        });

        // Element SDK Implementation
        async function onConfigChange(config) {
            document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
            document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
            document.getElementById('submit-btn-text').textContent = config.submit_button_text || defaultConfig.submit_button_text;
            
            const bgColor = config.background_color || defaultConfig.background_color;
            
            document.body.style.background = `linear-gradient(to bottom right, ${bgColor}, #ccfbf1, #a7f3d0)`;
        }

        // Initialize SDKs
        async function init() {
            if (window.dataSdk) {
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    showToast('error', 'Gagal menginisialisasi aplikasi');
                }
            }

            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities: (config) => ({
                        recolorables: [
                            {
                                get: () => config.background_color || defaultConfig.background_color,
                                set: (value) => {
                                    config.background_color = value;
                                    window.elementSdk.setConfig({ background_color: value });
                                }
                            },
                            {
                                get: () => config.surface_color || defaultConfig.surface_color,
                                set: (value) => {
                                    config.surface_color = value;
                                    window.elementSdk.setConfig({ surface_color: value });
                                }
                            },
                            {
                                get: () => config.text_color || defaultConfig.text_color,
                                set: (value) => {
                                    config.text_color = value;
                                    window.elementSdk.setConfig({ text_color: value });
                                }
                            },
                            {
                                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                                set: (value) => {
                                    config.primary_action_color = value;
                                    window.elementSdk.setConfig({ primary_action_color: value });
                                }
                            }
                        ],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ['school_name', config.school_name || defaultConfig.school_name],
                        ['app_title', config.app_title || defaultConfig.app_title],
                        ['submit_button_text', config.submit_button_text || defaultConfig.submit_button_text]
                    ])
                });
            }

            initTaskList();
        }

        init();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a1d4e2305674083',t:'MTc2MzY5Nzg5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>